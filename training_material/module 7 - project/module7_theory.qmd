---
title: "Module 7 Theory â€” Final Project"
format: html
editor: visual
---

## Step 1: Load Mock Raw Data

```{r}
library(tibble)
library(dplyr)
library(lubridate)

# Mock DM
dm <- tibble::tibble(
  USUBJID = c("01-001", "01-002"),
  AGE = c(34, 28),
  SEX = c("M", "F"),
  ARM = c("Placebo", "Treatment"),
  RFSTDTC = as.Date(c("2023-01-01", "2023-01-03"))
)

# Mock AE
ae <- tibble::tibble(
  USUBJID = c("01-001", "01-002"),
  AETERM = c("Headache", "Nausea"),
  AESTDTC = as.Date(c("2023-01-10", "2023-01-12")),
  AEENDTC = as.Date(c("2023-01-11", "2023-01-13")),
  AESEV = c("MILD", "MODERATE")
)

# Mock EX
ex <- tibble::tibble(
  USUBJID = c("01-001", "01-002"),
  EXSTDTC = as.Date(c("2023-01-02", "2023-01-04")),
  EXENDTC = as.Date(c("2023-01-06", "2023-01-08")),
  EXTRT = c("Drug A", "Drug B")
)
```

## Step 2: Derive SDTM domains

```{r}
dm <- dm %>%
  mutate(DOMAIN = "DM")

ae <- ae %>%
  mutate(DOMAIN = "AE",
         AESTDY = as.integer(AESTDTC - dm$RFSTDTC[match(USUBJID, dm$USUBJID)]),
         AEENDY = as.integer(AEENDTC - dm$RFSTDTC[match(USUBJID, dm$USUBJID)]),
         AESEQ = row_number())

ex <- ex %>%
  mutate(DOMAIN = "EX",
         EXDOSE = 50)
```

## Step 3: Derive ADSL

```{r}
adsl <- dm %>%
  select(USUBJID, AGE, SEX, ARM) %>%
  mutate(TRT01P = ARM)
```

## Step 4: Derive ADAE

```{r}
adae <- ae %>%
  left_join(adsl, by = "USUBJID") %>%
  mutate(ASEVFL = if_else(AESEV == "SEVERE", "Y", "N"),
         AVALC = AESEV)
```

## Step 5: Summary Table with gtsummary

```{r}
library(gtsummary)

adsl %>%
  select(AGE, SEX, TRT01P) %>%
  tbl_summary(by = TRT01P, statistic = list(all_continuous() ~ "{mean} ({sd})"))
```

## Step 6: AE Listing with flextable

```{r}
library(flextable)

adae %>%
  select(USUBJID, AETERM, AESEV, AESTDTC, AEENDTC) %>%
  flextable()
```

## Step 7: AE Plot

```{r}
library(ggplot2)

ggplot(adae, aes(x = TRT01P, fill = AESEV)) +
  geom_bar(position = "dodge") +
  labs(title = "Adverse Events by Severity and Treatment", x = "Treatment", y = "Count")
```
