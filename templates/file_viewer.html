{% extends "base.html" %}

{% block title %}View {{ filename }} - TransitionR{% endblock %}

{% block content %}
<!-- QMD Viewer Header -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('modules') }}">Modules</a></li>
                        <li class="breadcrumb-item active" aria-current="page">View {{ filename.split('/')[-1] }}</li>
                    </ol>
                </nav>
                
                <div class="d-flex align-items-center mb-3">
                    <h1 class="mb-0">
                        <i class="fas fa-file-code me-2 text-primary"></i>{{ filename.split('/')[-1] }}
                    </h1>
                </div>
                
                <p class="lead text-muted">
                    {% if file_type == 'r' %}R Script Viewer
                    {% elif file_type == 'markdown' %}Markdown Document Viewer  
                    {% elif file_type == 'text' %}Text File Viewer
                    {% else %}Document Viewer
                    {% endif %}
                </p>
                {% if message %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>{{ message }}
                </div>
                {% endif %}
            </div>
            <div class="col-lg-4 text-end">
                <a href="{{ url_for('download_file', filename=filename) }}" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Download File
                </a>
            </div>
        </div>
    </div>
</section>

<!-- QMD Content -->
<section class="py-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-eye me-2 text-primary"></i>Content Preview
                            </h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSyntaxHighlighting()">
                                    <i class="fas fa-code me-1"></i>Syntax Highlighting
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleLineNumbers()">
                                    <i class="fas fa-list-ol me-1"></i>Line Numbers
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="qmd-content" class="bg-light p-4" style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; max-height: 600px; overflow-y: auto;">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading content...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>

<script>
let syntaxHighlightingEnabled = true;
let lineNumbersEnabled = true;

// Load the content
document.addEventListener('DOMContentLoaded', function() {
    const hasContent = {{ 'true' if content else 'false' }};
    if (hasContent) {
        // Content is already provided (for R files)
        const content = {{ content | tojson | safe if content else '""' }};
        displayContent(content);
    } else {
        // Need to fetch QMD content
        loadQmdContent();
    }
});

function loadQmdContent() {
    const filename = '{{ filename }}';
    fetch(`/view_qmd/${filename}`)
        .then(response => response.text())
        .then(content => {
            displayContent(content);
        })
        .catch(error => {
            document.getElementById('qmd-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading content: ${error.message}
                </div>
            `;
        });
}

function displayContent(content) {
    const container = document.getElementById('qmd-content');
    const fileType = '{{ file_type }}' || 'text';
    
    // Determine the language for syntax highlighting
    let language = 'text';
    if (fileType === 'r') {
        language = 'r';
    } else if (fileType === 'markdown') {
        language = 'markdown';
    } else if (fileType === 'html') {
        language = 'html';
    }
    
    // Escape HTML characters
    const escapedContent = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    
    // Create content with or without line numbers
    let displayContent = escapedContent;
    if (lineNumbersEnabled) {
        const lines = escapedContent.split('\n');
        displayContent = lines.map((line, index) => 
            `<span class="line-number">${(index + 1).toString().padStart(3, ' ')}</span> ${line}`
        ).join('\n');
        
        container.innerHTML = `<pre class="line-numbers"><code class="language-${language}">${displayContent}</code></pre>`;
    } else {
        container.innerHTML = `<pre><code class="language-${language}">${displayContent}</code></pre>`;
    }
    
    // Apply syntax highlighting if enabled
    if (syntaxHighlightingEnabled) {
        Prism.highlightAll();
    }
}

function toggleSyntaxHighlighting() {
    syntaxHighlightingEnabled = !syntaxHighlightingEnabled;
    const button = event.target.closest('button');
    if (syntaxHighlightingEnabled) {
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
        Prism.highlightAll();
    } else {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-outline-secondary');
        // Remove syntax highlighting
        const codeElements = document.querySelectorAll('code');
        codeElements.forEach(code => {
            code.className = code.className.replace(/language-\w+/g, '');
        });
    }
}

function toggleLineNumbers() {
    lineNumbersEnabled = !lineNumbersEnabled;
    const button = event.target.closest('button');
    if (lineNumbersEnabled) {
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
    } else {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-outline-secondary');
    }
    // Reload content with new line number setting
    loadQmdContent();
}
</script>

<style>
.line-number {
    color: #6c757d;
    font-weight: bold;
    margin-right: 10px;
    user-select: none;
}

#qmd-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin: 0;
    padding: 1rem;
}

#qmd-content code {
    background: transparent;
    padding: 0;
    font-size: 14px;
    line-height: 1.6;
}
</style>
{% endblock %} 