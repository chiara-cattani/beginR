{% extends "base.html" %}

{% block title %}View {{ filename }} - TransitionR{% endblock %}

{% block content %}
<!-- QMD Viewer Header -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h1 class="mb-0">
                        <i class="fas fa-file-code me-2 text-primary"></i>{{ filename.split('/')[-1] }}
                    </h1>
                    <a href="{{ url_for('download_file', filename=filename) }}" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Download File
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- QMD Content -->
<section class="py-2">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-eye me-2 text-primary"></i>Content Preview
                            </h5>
                            <div class="btn-group" role="group">
                                <button type="button" id="syntaxBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleSyntaxHighlighting()" style="opacity: 0.7;">
                                    <i class="fas fa-code me-1"></i>Syntax Highlighting
                                </button>
                                <button type="button" id="lineNumbersBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleLineNumbers()" style="opacity: 0.7;">
                                    <i class="fas fa-list-ol me-1"></i>Line Numbers
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="qmd-content" class="bg-light p-4" style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; max-height: 600px; overflow-y: auto;">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading content...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>

<script>
let syntaxHighlightingEnabled = true;
let lineNumbersEnabled = true;

// Load the content
document.addEventListener('DOMContentLoaded', function() {
    const hasContent = {{ 'true' if content else 'false' }};
    if (hasContent) {
        // Content is already provided (for R files)
        const content = {{ content | tojson | safe if content else '""' }};
        displayContent(content);
    } else {
        // Need to fetch QMD content
        loadQmdContent();
    }
});

function loadQmdContent() {
    const filename = '{{ filename }}';
    fetch(`/view_qmd/${filename}`)
        .then(response => response.text())
        .then(content => {
            displayContent(content);
        })
        .catch(error => {
            document.getElementById('qmd-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading content: ${error.message}
                </div>
            `;
        });
}

function displayContent(content) {
    const container = document.getElementById('qmd-content');
    const filename = '{{ filename }}' || '';
    
    // Determine the language for syntax highlighting based on file extension
    let language = 'text';
    if (filename.toLowerCase().endsWith('.r')) {
        language = 'r';
    } else if (filename.toLowerCase().endsWith('.qmd') || filename.toLowerCase().endsWith('.md')) {
        language = 'markdown';
    } else if (filename.toLowerCase().endsWith('.html') || filename.toLowerCase().endsWith('.htm')) {
        language = 'html';
    } else if (filename.toLowerCase().endsWith('.js')) {
        language = 'javascript';
    } else if (filename.toLowerCase().endsWith('.py')) {
        language = 'python';
    }
    
    // Escape HTML characters
    const escapedContent = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    
    // Create content with or without line numbers
    let displayContent = escapedContent;
    if (lineNumbersEnabled) {
        const lines = escapedContent.split('\n');
        displayContent = lines.map((line, index) => 
            `<span class="line-number">${(index + 1).toString().padStart(3, ' ')}</span> ${line}`
        ).join('\n');
        
        container.innerHTML = `<pre class="line-numbers"><code class="language-${language}">${displayContent}</code></pre>`;
    } else {
        container.innerHTML = `<pre><code class="language-${language}">${displayContent}</code></pre>`;
    }
    
    // Apply syntax highlighting if enabled
    if (syntaxHighlightingEnabled) {
        // Ensure Prism is loaded before highlighting
        setTimeout(() => {
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        }, 100);
    }
}

function toggleLineNumbers() {
    lineNumbersEnabled = !lineNumbersEnabled;
    const button = document.getElementById('lineNumbersBtn');
    if (lineNumbersEnabled) {
        // When selected/enabled: show as transparent
        button.classList.remove('btn-secondary');
        button.classList.add('btn-outline-secondary');
        button.style.opacity = '0.7';
    } else {
        // When not selected/disabled: show as grey
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
        button.style.opacity = '1';
    }
    // Reload content with new line number setting
    const hasContent = {{ 'true' if content else 'false' }};
    if (hasContent) {
        // For R files and other directly provided content
        const content = {{ content | tojson | safe if content else '""' }};
        displayContent(content);
    } else {
        // For QMD files that need to be fetched
        loadQmdContent();
    }
}

function toggleSyntaxHighlighting() {
    syntaxHighlightingEnabled = !syntaxHighlightingEnabled;
    const button = document.getElementById('syntaxBtn');
    if (syntaxHighlightingEnabled) {
        // When selected/enabled: show as transparent
        button.classList.remove('btn-secondary');
        button.classList.add('btn-outline-secondary');
        button.style.opacity = '0.7';
    } else {
        // When not selected/disabled: show as grey
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
        button.style.opacity = '1';
    }
    // Reload content with new syntax highlighting setting
    const hasContent = {{ 'true' if content else 'false' }};
    if (hasContent) {
        // For R files and other directly provided content
        const content = {{ content | tojson | safe if content else '""' }};
        displayContent(content);
    } else {
        // For QMD files that need to be fetched
        loadQmdContent();
    }
}

</script>

<style>
.line-number {
    color: #6c757d;
    font-weight: bold;
    margin-right: 10px;
    user-select: none;
}

#qmd-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin: 0;
    padding: 1rem;
}

#qmd-content code {
    background: transparent;
    padding: 0;
    font-size: 14px;
    line-height: 1.6;
}
</style>
{% endblock %} 