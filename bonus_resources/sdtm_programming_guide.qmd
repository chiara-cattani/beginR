---
title: "SDTM Programming Guide"
subtitle: "Production CDISC SDTM Domain Creation from Raw Clinical Data"
format: 
  html:
    toc: true
    toc-depth: 3
    theme: flatly
    code-fold: false
  pdf:
    toc: true
    number-sections: true
editor: visual
---

# ðŸ“Š SDTM Programming Guide

Production CDISC SDTM Domain Creation from Raw Clinical Data using R.

**Clinical Programming Training - SDTM Implementation Guide v1.7**  
Uses `sdtm.oak` package for metadata-driven programming.

## Overview

This guide demonstrates how to convert raw clinical data to SDTM-compliant domains using R programming techniques that mirror SAS clinical programming practices.

## Required Libraries

```{r}
#| label: setup
#| message: false
#| warning: false

library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
# library(haven)       # For reading SAS datasets - not needed for this demo
# library(sdtm.oak)    # Uncomment when sdtm.oak is available

cat("=== CDISC SDTM Domain Creation ===\n")
cat("Converting raw clinical data to SDTM-compliant domains\n\n")
```

## Study Parameters

```{r}
#| label: study-params

# Set study parameters
STUDY_ID <- "ABC-123"
STUDY_RFSTDTC <- as.Date("2024-01-15")  # Common study start date
```

## Mock Raw Clinical Data

This represents CRF/EDC data that would typically come from your clinical database.

### Raw Demographics Data

```{r}
#| label: raw-demographics

# Raw Demographics Data (typically from EDC)
raw_demographics <- data.frame(
  subject_id = sprintf("%03d", 1:25),
  site_number = sample(c("001", "002", "003"), 25, replace = TRUE),
  birth_date = sample(seq(as.Date("1950-01-01"), as.Date("1990-12-31"), by = "day"), 25),
  gender = sample(c("Male", "Female"), 25, replace = TRUE, prob = c(0.55, 0.45)),
  race = sample(c("White", "Black or African American", "Asian", "American Indian or Alaska Native"), 
                25, replace = TRUE, prob = c(0.7, 0.15, 0.12, 0.03)),
  ethnicity = sample(c("Hispanic or Latino", "Not Hispanic or Latino"), 
                     25, replace = TRUE, prob = c(0.2, 0.8)),
  consent_date = STUDY_RFSTDTC + sample(-30:30, 25, replace = TRUE),
  randomization_date = NA,  # Will be filled based on treatment assignment
  stringsAsFactors = FALSE
)

print("Raw Demographics Data Structure:")
glimpse(raw_demographics)
```

### Raw Vital Signs Data

```{r}
#| label: raw-vitals

# Raw Vital Signs Data
# Generate multiple visits per subject
set.seed(123)
visits <- c("Screening", "Baseline", "Week 2", "Week 4", "Week 8", "Week 12", "End of Study")

raw_vitals_list <- lapply(raw_demographics$subject_id, function(subj) {
  n_visits <- sample(4:7, 1)  # Random number of visits per subject
  selected_visits <- sample(visits, n_visits)
  
  data.frame(
    subject_id = subj,
    visit = selected_visits,
    visit_date = STUDY_RFSTDTC + cumsum(sample(7:28, n_visits, replace = TRUE)),
    systolic_bp = round(rnorm(n_visits, 125, 15)),
    diastolic_bp = round(rnorm(n_visits, 80, 10)),
    heart_rate = round(rnorm(n_visits, 72, 12)),
    weight_kg = round(rnorm(n_visits, 75, 15), 1),
    height_cm = round(rnorm(n_visits, 170, 10), 1),
    temperature_c = round(rnorm(n_visits, 36.5, 0.5), 1)
  )
})

raw_vitals <- do.call(rbind, raw_vitals_list)

print("Raw Vital Signs Data Structure:")
glimpse(raw_vitals)
```

## SDTM Domain Creation

### Demographics (DM) Domain

The DM domain contains demographics and administrative information for each subject.

```{r}
#| label: create-dm

# Create SDTM DM (Demographics) Domain
dm_domain <- raw_demographics %>%
  mutate(
    # Standard SDTM variables
    STUDYID = STUDY_ID,
    DOMAIN = "DM",
    USUBJID = paste(STUDY_ID, subject_id, sep = "-"),
    SUBJID = subject_id,
    SITEID = site_number,
    
    # Demographics
    AGE = as.numeric(floor(difftime(STUDY_RFSTDTC, birth_date, units = "days") / 365.25)),
    AGEU = "YEARS",
    SEX = case_when(
      gender == "Male" ~ "M",
      gender == "Female" ~ "F",
      TRUE ~ ""
    ),
    RACE = case_when(
      race == "White" ~ "WHITE",
      race == "Black or African American" ~ "BLACK OR AFRICAN AMERICAN", 
      race == "Asian" ~ "ASIAN",
      race == "American Indian or Alaska Native" ~ "AMERICAN INDIAN OR ALASKA NATIVE",
      TRUE ~ "UNKNOWN"
    ),
    ETHNIC = case_when(
      ethnicity == "Hispanic or Latino" ~ "HISPANIC OR LATINO",
      ethnicity == "Not Hispanic or Latino" ~ "NOT HISPANIC OR LATINO",
      TRUE ~ "UNKNOWN"
    ),
    
    # Study dates
    RFSTDTC = format(STUDY_RFSTDTC, "%Y-%m-%d"),
    RFENDTC = "",  # To be populated when study ends
    DTHDTC = "",   # Death date if applicable
    DTHFL = ""     # Death flag
  ) %>%
  
  # Assign treatment arms (simplified randomization)
  mutate(
    ARM = sample(c("Treatment A", "Treatment B", "Placebo"), nrow(.), replace = TRUE),
    ARMCD = case_when(
      ARM == "Treatment A" ~ "TRT_A",
      ARM == "Treatment B" ~ "TRT_B", 
      ARM == "Placebo" ~ "PBO",
      TRUE ~ ""
    ),
    ACTARM = ARM,
    ACTARMCD = ARMCD
  ) %>%
  
  # Select final SDTM variables in proper order
  select(STUDYID, DOMAIN, USUBJID, SUBJID, SITEID, AGE, AGEU, SEX, RACE, ETHNIC,
         ARM, ARMCD, ACTARM, ACTARMCD, RFSTDTC, RFENDTC, DTHDTC, DTHFL)

# Display sample of DM domain
print("SDTM DM Domain (first 10 subjects):")
print(dm_domain %>% slice(1:10))

# Verify SDTM compliance
cat("\n=== DM Domain Validation ===\n")
cat("Number of subjects:", nrow(dm_domain), "\n")
cat("Required variables present:", all(c("STUDYID", "DOMAIN", "USUBJID") %in% names(dm_domain)), "\n")
cat("Unique subjects:", length(unique(dm_domain$USUBJID)), "\n")
```

### Vital Signs (VS) Domain

The VS domain contains vital signs measurements.

```{r}
#| label: create-vs

# Create SDTM VS (Vital Signs) Domain
vs_domain <- raw_vitals %>%
  
  # Create individual records for each vital sign measurement
  pivot_longer(
    cols = c(systolic_bp, diastolic_bp, heart_rate, weight_kg, height_cm, temperature_c),
    names_to = "vital_sign",
    values_to = "measurement"
  ) %>%
  
  # Map to SDTM variables
  mutate(
    STUDYID = STUDY_ID,
    DOMAIN = "VS", 
    USUBJID = paste(STUDY_ID, subject_id, sep = "-"),
    
    # Test details
    VSTESTCD = case_when(
      vital_sign == "systolic_bp" ~ "SYSBP",
      vital_sign == "diastolic_bp" ~ "DIABP", 
      vital_sign == "heart_rate" ~ "HR",
      vital_sign == "weight_kg" ~ "WEIGHT",
      vital_sign == "height_cm" ~ "HEIGHT",
      vital_sign == "temperature_c" ~ "TEMP",
      TRUE ~ ""
    ),
    
    VSTEST = case_when(
      VSTESTCD == "SYSBP" ~ "Systolic Blood Pressure",
      VSTESTCD == "DIABP" ~ "Diastolic Blood Pressure",
      VSTESTCD == "HR" ~ "Heart Rate",
      VSTESTCD == "WEIGHT" ~ "Weight",
      VSTESTCD == "HEIGHT" ~ "Height", 
      VSTESTCD == "TEMP" ~ "Temperature",
      TRUE ~ ""
    ),
    
    VSORRES = as.character(measurement),
    VSORRESU = case_when(
      VSTESTCD %in% c("SYSBP", "DIABP") ~ "mmHg",
      VSTESTCD == "HR" ~ "beats/min",
      VSTESTCD == "WEIGHT" ~ "kg",
      VSTESTCD == "HEIGHT" ~ "cm",
      VSTESTCD == "TEMP" ~ "C",
      TRUE ~ ""
    ),
    
    VSSTRESC = VSORRES,
    VSSTRESN = as.numeric(measurement),
    VSSTRESU = VSORRESU,
    
    # Visit information
    VISIT = visit,
    VISITNUM = case_when(
      visit == "Screening" ~ 1,
      visit == "Baseline" ~ 2,
      visit == "Week 2" ~ 3,
      visit == "Week 4" ~ 4,
      visit == "Week 8" ~ 5,
      visit == "Week 12" ~ 6,
      visit == "End of Study" ~ 7,
      TRUE ~ 99
    ),
    
    VSDTC = format(visit_date, "%Y-%m-%d"),
    VSDY = as.numeric(visit_date - STUDY_RFSTDTC) + 1,
    
    # Additional variables  
    VSPOS = "SITTING",
    VSLOC = case_when(
      VSTESTCD %in% c("SYSBP", "DIABP") ~ "ARM",
      TRUE ~ ""
    )
  ) %>%
  
  # Filter out missing measurements
  filter(!is.na(measurement)) %>%
  
  # Generate sequence numbers
  group_by(USUBJID, VISIT, VSTESTCD) %>%
  mutate(VSSEQ = row_number()) %>%
  ungroup() %>%
  
  # Select final SDTM variables
  select(STUDYID, DOMAIN, USUBJID, VSSEQ, VSTESTCD, VSTEST, VSORRES, VSORRESU,
         VSSTRESC, VSSTRESN, VSSTRESU, VISIT, VISITNUM, VSDTC, VSDY, VSPOS, VSLOC)

# Display sample of VS domain
print("SDTM VS Domain (first 15 records):")
print(vs_domain %>% slice(1:15))

# Validation
cat("\n=== VS Domain Validation ===\n")
cat("Total vital signs records:", nrow(vs_domain), "\n")
cat("Unique test codes:", length(unique(vs_domain$VSTESTCD)), "\n") 
cat("Test codes present:", paste(unique(vs_domain$VSTESTCD), collapse = ", "), "\n")
cat("Date range:", min(vs_domain$VSDTC), "to", max(vs_domain$VSDTC), "\n")
```

## Quality Control Checks

### Data Quality Summary

```{r}
#| label: qc-checks

cat("=== SDTM Data Quality Summary ===\n\n")

# DM Domain QC
cat("DM Domain Checks:\n")
cat("- Complete USUBJID:", all(!is.na(dm_domain$USUBJID) & dm_domain$USUBJID != ""), "\n")
cat("- Valid AGE range:", all(dm_domain$AGE >= 18 & dm_domain$AGE <= 90), "\n")
cat("- Sex values M/F only:", all(dm_domain$SEX %in% c("M", "F")), "\n")
cat("- ARM assigned to all:", all(!is.na(dm_domain$ARM) & dm_domain$ARM != ""), "\n")

# VS Domain QC  
cat("\nVS Domain Checks:\n")
cat("- All records have USUBJID:", all(!is.na(vs_domain$USUBJID)), "\n")
cat("- Numeric results present:", all(!is.na(vs_domain$VSSTRESN)), "\n")
cat("- Units consistent per test:", 
    vs_domain %>% 
      group_by(VSTESTCD) %>% 
      summarise(unit_count = n_distinct(VSSTRESU)) %>% 
      summarise(all_single_unit = all(unit_count == 1)) %>% 
      pull(all_single_unit), "\n")

# Cross-domain checks
cat("\nCross-Domain Checks:\n") 
common_subjects_dm <- unique(dm_domain$USUBJID)
common_subjects_vs <- unique(vs_domain$USUBJID)
cat("- Subjects in both DM and VS:", length(intersect(common_subjects_dm, common_subjects_vs)), "\n")
cat("- Subjects only in DM:", length(setdiff(common_subjects_dm, common_subjects_vs)), "\n")
cat("- Subjects only in VS:", length(setdiff(common_subjects_vs, common_subjects_dm)), "\n")
```

## Export SDTM Datasets

```{r}
#| label: export-datasets
#| eval: false

# Export to SAS transport files (XPT format)
# haven::write_xpt(list(dm = dm_domain), "dm.xpt")
# haven::write_xpt(list(vs = vs_domain), "vs.xpt") 

# Or export to CSV for review
# write.csv(dm_domain, "dm.csv", row.names = FALSE)
# write.csv(vs_domain, "vs.csv", row.names = FALSE)

cat("SDTM datasets ready for export\n")
cat("- DM domain: ", nrow(dm_domain), " records\n")
cat("- VS domain: ", nrow(vs_domain), " records\n")
```

## Key Programming Notes

### R vs SAS Equivalencies

- **Data manipulation**: `dplyr` replaces `DATA` steps
- **Conditional logic**: `case_when()` replaces `IF-THEN-ELSE`
- **Date calculations**: `lubridate` functions replace SAS date functions
- **Reshaping data**: `pivot_longer()` replaces `PROC TRANSPOSE`
- **Grouping operations**: `group_by() %>% summarise()` replaces `PROC MEANS`

### CDISC Compliance

- All required SDTM variables are included
- Controlled terminology is properly applied
- Cross-domain relationships are maintained
- Data types follow SDTM standards

### Validation Strategy

1. **Metadata-driven programming** using `sdtm.oak` (when available)
2. **Automated quality checks** for data completeness
3. **Cross-domain validation** for referential integrity
4. **Controlled terminology validation** against CDISC CT

---

*This guide demonstrates production-ready SDTM programming techniques for clinical trials data processing using R.*