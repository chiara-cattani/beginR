name: Pull Request Checks

permissions:
  contents: read
  security-events: write

on:
  pull_request:
    branches: [ main, dev ]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.changes.outputs.python }}
      frontend: ${{ steps.changes.outputs.frontend }}
      config: ${{ steps.changes.outputs.config }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            python:
              - '**/*.py'
              - 'requirements*.txt'
            frontend:
              - 'static/**'
              - 'templates/**'
            config:
              - '.github/**'
              - '*.yml'
              - '*.yaml'
              - '*.toml'
              - '*.ini'
              - '*.cfg'

  python-check:
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.11]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Format check
      run: |
        black --check --diff .
        isort --check-only --diff .

    - name: Lint
      run: |
        flake8 . --count --statistics

    - name: Security check
      run: |
        bandit -r . -f json -o bandit-report.json || true

    - name: Test
      run: |
        pytest --junitxml=pytest.xml --cov-report=term-missing --cov=. || echo "Tests completed"

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          pytest.xml
          coverage.xml
          bandit-report.json

  frontend-check:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install tools
      run: |
        npm ci

    - name: Check HTML
      run: |
        npm run lint:html || true

    - name: Check CSS
      run: |
        npx stylelint "static/css/*.css" --config-basedir ./node_modules || true

    - name: Check JavaScript
      run: |
        npm run lint:js || true

  size-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check file sizes
      run: |
        echo "## File Size Report" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        find . -type f -size +1M -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "| $file | $size |" >> $GITHUB_STEP_SUMMARY
        done

  pr-comment:
    needs: [python-check, frontend-check, size-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Comment PR
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user?.type === 'Bot' && comment.body.includes('## CI/CD Results')
          );

          const pythonStatus = '${{ needs.python-check.result }}';
          const frontendStatus = '${{ needs.frontend-check.result }}';

          const body = `## CI/CD Results

| Check | Status |
|-------|--------|
| Python Code Quality | ${pythonStatus === 'success' ? '✅ Passed' : pythonStatus === 'skipped' ? '⏭️ Skipped' : '❌ Failed'} |
| Frontend Validation | ${frontendStatus === 'success' ? '✅ Passed' : frontendStatus === 'skipped' ? '⏭️ Skipped' : '❌ Failed'} |
| File Size Check | ✅ Completed |

${pythonStatus === 'failure' || frontendStatus === 'failure' ? '❌ Some checks failed. Please review the logs and fix issues before merging.' : '✅ All checks passed! Ready for review.'}

*This comment was automatically generated by the CI/CD pipeline.*`;

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
